<?xml version="1.0" encoding="iso-8859-1"?>
<!--
=======================================================================
= Project:     openMDX, http://www.openmdx.org/
= Description: openMDX Build Library
= Owner:       OMEX AG, Switzerland, http://www.omex.ch
=======================================================================
=
= This software is published under the BSD license as listed below.
= 
= Copyright (c) 2004-2020, OMEX AG, Switzerland
= All rights reserved.
= 
= Redistribution and use in source and binary forms, with or without 
= modification, are permitted provided that the following conditions 
= are met:
= 
= * Redistributions of source code must retain the above copyright
=   notice, this list of conditions and the following disclaimer.
= 
= * Redistributions in binary form must reproduce the above copyright
=   notice, this list of conditions and the following disclaimer in
=   the documentation and/or other materials provided with the
=   distribution.
= 
= * Neither the name of the openMDX team nor the names of its
=   contributors may be used to endorse or promote products derived
=   from this software without specific prior written permission.
= 
= THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
= CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES,
= INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
= MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
= DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
= BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
= EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
= TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
= DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
= ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
= OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
= OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
= POSSIBILITY OF SUCH DAMAGE.
= 
-->
<project 
	name="openmdx-build-library" 
	xmlns:openmdx="xri://(antlib:org.openmdx.tools.ant)" 
	xmlns:antcontrib="antlib:net.sf.antcontrib"
>

	<!--*******************************************************************
	* Ant contrib tasks (http://ant-contrib.sourceforge.net/)
	********************************************************************-->
	<!-- Namespace Mode -->
	<taskdef resource="net/sf/antcontrib/antlib.xml" uri="antlib:net.sf.antcontrib">
		<classpath>
			<pathelement location="${openmdx.home}/apache/jre-1.2/contribution/lib/ant-contrib.jar"/>
		</classpath>
	</taskdef>

	<!--*******************************************************************
	* openMDX Ant tasks
	********************************************************************-->
	<antcontrib:if>
		<equals arg1="${ant.project.name}" arg2="openmdx-ant"/>
		<antcontrib:then>
			<antcontrib:if>
				<available file="${build.dir}/bin/org/openmdx/tools/ant/types/ManifestType.class"/>
				<antcontrib:then>
					<taskdef 
						resource="org/openmdx/tools/ant/antlib.xml" 
						uri="xri://(antlib:org.openmdx.tools.ant)"
					>
						<classpath>
							<path refid="project.bin.classpath"/>
						</classpath>
					</taskdef>
					<property name="org.openmdx.tools.ant.is.available" value="true"/>
				</antcontrib:then>
			</antcontrib:if>
		</antcontrib:then>
		<antcontrib:else>
			<componentdef 
				classname="org.openmdx.tools.ant.componentdefs.PropertyOperations"
			    name="propertyoperations"
			>
				<classpath id="openmdx.ant">
					<pathelement location="${openmdx.home}/${build.java.platform}/ant/lib/openmdx-ant.jar"/>
				</classpath>
			</componentdef>
			<propertyhelper>
				<propertyoperations/>
			</propertyhelper>
			<taskdef 
				resource="org/openmdx/tools/ant/antlib.xml" 
				uri="xri://(antlib:org.openmdx.tools.ant)"
				classpathref="openmdx.ant"
			/>
			<property name="org.openmdx.tools.ant.is.available" value="true"/>
		</antcontrib:else>
	</antcontrib:if>
	<!--*******************************************************************
	* Project Help
	********************************************************************-->
	<target name="-projecthelp" description="Print project help information">
		<java
	        classname="org.apache.tools.ant.launch.Launcher"
	        fork="true"
	        failonerror="true"
	        dir="${basedir}"
	        timeout="4000000"
	        taskname="help"
		>
			<classpath>
				<pathelement location="${ant.home}/lib/ant-launcher.jar"/>
			</classpath>
			<arg value="-buildfile"/>
			<arg file="${ant.file}"/>
			<arg value="-projecthelp"/>
		</java>
	</target>
	<!--*******************************************************************
	* Configuration
	********************************************************************-->
	<target name="config" description="Print project configuration information" depends="init">
		<available file="${user.build.properties}" type="file" value="+" property="user.build.properties.are.present"/>
		<property name="user.build.properties.are.present" value="-"/>
		<available file="${java.vendor.properties}" type="file" value="+" property="java.vendor.properties.are.present"/>
		<property name="java.vendor.properties.are.present" value="-"/>
		<available file="${target.platform.properties}" type="file" value="+" property="target.platform.properties.are.present"/>
		<property name="target.platform.properties.are.present" value="-"/>
		<available file="${java.platform.properties}" type="file" value="+" property="java.platform.properties.are.present"/>
		<property name="java.platform.properties.are.present" value="-"/>
		<available file="${project.build.properties}" type="file" value="+" property="project.build.properties.are.present"/>
		<property name="project.build.properties.are.present" value="-"/>
		<available file="${project.version.properties}" type="file" value="+" property="project.version.properties.are.present"/>
		<property name="project.version.properties.are.present" value="-"/>
		<available file="${build.target.jre}" type="dir" value="+" property="build.target.jre.is.present"/>
		<property name="build.target.jre.is.present" value="-"/>
		<condition property="build.target.platform.is.included" value="-">
			<isset property="build.exclude.platform"/>
		</condition>
		<property name="build.target.platform.is.included" value="+"/>
		<condition property="JRE_12.info" value="[-]">
			<not>
				<isset property="env.JRE_12"/>
			</not>
		</condition>
		<available file="${env.JRE_12}" type="dir" value="[+] ${env.JRE_12}" property="JRE_12.info"/>
		<property name="JRE_12.info" value="[-] ${env.JRE_12}"/>
		<condition property="JRE_13.info" value="[-]">
			<not>
				<isset property="env.JRE_13"/>
			</not>
		</condition>
		<available file="${env.JRE_13}" type="dir" value="[+] ${env.JRE_13}" property="JRE_13.info"/>
		<property name="JRE_13.info" value="[-] ${env.JRE_13}"/>
		<condition property="JRE_14.info" value="[-]">
			<not>
				<isset property="env.JRE_14"/>
			</not>
		</condition>
		<available file="${env.JRE_14}" type="dir" value="[+] ${env.JRE_14}" property="JRE_14.info"/>
		<property name="JRE_14.info" value="[-] ${env.JRE_14}"/>
		<condition property="JRE_15.info" value="[-]">
			<not>
				<isset property="env.JRE_15"/>
			</not>
		</condition>
		<available file="${env.JRE_15}" type="dir" value="[+] ${env.JRE_15}" property="JRE_15.info"/>
		<property name="JRE_15.info" value="[-] ${env.JRE_15}"/>
		<condition property="JRE_16.info" value="[-]">
			<not>
				<isset property="env.JRE_16"/>
			</not>
		</condition>
		<available file="${env.JRE_16}" type="dir" value="[+] ${env.JRE_16}" property="JRE_16.info"/>
		<property name="JRE_16.info" value="[-] ${env.JRE_16}"/>
		<condition property="JRE_17.info" value="[-]">
			<not>
				<isset property="env.JRE_17"/>
			</not>
		</condition>
		<available file="${env.JRE_17}" type="dir" value="[+] ${env.JRE_17}" property="JRE_17.info"/>
		<property name="JRE_17.info" value="[-] ${env.JRE_17}"/>
		<condition property="JRE_18.info" value="[-]">
			<not>
				<isset property="env.JRE_18"/>
			</not>
		</condition>
		<available file="${env.JRE_18}" type="dir" value="[+] ${env.JRE_18}" property="JRE_18.info"/>
		<property name="JRE_18.info" value="[-] ${env.JRE_18}"/>
		<condition property="unix.distribution.is-set">
			<isset property="unix.distribution"/>
		</condition>
		<available file="${env.JDK_11}" type="dir" value="[+] ${env.JDK_11}" property="JDK_11.info"/>
		<property name="JDK_11.info" value="[-] ${env.JDK_11}"/>
		<condition property="unix.distribution.is-set">
			<isset property="unix.distribution"/>
		</condition>
		<property name="unix.distribution.is-set" value="not set"/>
		<condition property="source.distribution.is-set">
			<isset property="source.distribution"/>
		</condition>
		<property name="source.distribution.is-set" value="not set"/>
		<echo message="user.build.properties               = [${user.build.properties.are.present}] ${user.build.properties}"/>
		<echo message="java.vendor.properties              = [${java.vendor.properties.are.present}] ${java.vendor.properties}"/>
		<echo message="target.platform.properties          = [${target.platform.properties.are.present}] ${target.platform.properties}"/>
		<echo message="java.platform.properties            = [${java.platform.properties.are.present}] ${java.platform.properties}"/>
		<echo message="project.build.properties            = [${project.build.properties.are.present}] ${project.build.properties}"/>
		<echo message="project.version.properties          = [${project.version.properties.are.present}] ${project.version.properties}"/>
		<echo/>
		<echo message="ant.home                            = ${ant.home}"/>
		<echo message="openmdx.home                        = ${openmdx.home}"/>
		<echo message="java.home                           = ${java.home}"/>
		<echo message="project.home                        = ${project.home}"/>
		<echo/>
		<echo message="build.target.jre                    = [${build.target.jre.is.present}] ${build.target.jre}"/>
		<echo message="JRE_12                              = ${JRE_12.info}"/>
		<echo message="JRE_13                              = ${JRE_13.info}"/>
		<echo message="JRE_14                              = ${JRE_14.info}"/>
		<echo message="JRE_15                              = ${JRE_15.info}"/>
		<echo message="JRE_16                              = ${JRE_16.info}"/>
		<echo message="JRE_17                              = ${JRE_17.info}"/>
		<echo message="JRE_18                              = ${JRE_18.info}"/>
		<echo message="JDK_11                              = ${JDK_11.info}"/>
		<echo/>
		<echo message="ant.version                         = ${ant.version}"/>
		<echo message="ant.java.version                    = ${ant.java.version}"/>
		<echo message="ant.project.name                    = ${ant.project.name}"/>
		<echo/>
		<echo message="basedir                             = ${basedir}"/>
		<echo message="base.dir.name                       = ${base.dir.name}"/>
		<echo message="build.dir                           = ${build.dir}"/>
		<echo message="tmp.dir                             = ${tmp.dir}"/>
		<echo message="log.dir                             = ${log.dir}"/>
		<echo message="deliver.dir                         = ${deliver.dir}"/>
		<echo message="distribution.dir                    = ${distribution.dir}"/>
		<echo/>
		<echo message="project.vendor.name                 = ${project.vendor.name}"/>
		<echo message="project.vendor.id                   = ${project.vendor.id}"/>
		<echo message="project.specification.title         = ${project.specification.title}"/>
		<echo message="project.specification.version       = ${project.specification.version}"/>
		<echo message="project.implementation.version      = ${project.implementation.version}"/>
		<echo message="project.implementation.prefix       = ${project.implementation.prefix}"/>
		<echo message="project.platform.list               = ${project.platform.list}"/>
		<echo/>
		<echo message="build.target.platform               = [${build.target.platform.is.included}] ${build.target.platform}"/>
		<echo message="build.java.platform                 = ${build.java.platform}"/>
		<echo message="build.target.version                = ${build.target.version}"/>
		<echo message="build.source.version                = ${build.source.version}"/>
		<echo message="build.debug                         = ${build.debug}"/>
		<echo message="build.optimize                      = ${build.optimize}"/>
		<echo/>
		<echo message="unix.distribution                   = ${unix.distribution.is-set}"/>
		<echo message="source.distribution                 = ${source.distribution.is-set}"/>
		<echo message="distribution.format                 = ${distribution.format}"/>
		<echo/>
		<echo message="junit.test.halt.on.error            = ${junit.test.halt.on.error}"/>
		<echo message="junit.test.halt.on.failure          = ${junit.test.halt.on.failure}"/>
		<echo message="junit.test.log.level                = ${junit.test.log.level}"/>
		<echo message="junit.test.log.debug                = ${junit.test.log.debug}"/>
		<echo message="junit.test.report                   = ${junit.test.report}"/>
		<condition property="junit.test.timezone.info" value="${junit.test.timezone}">
			<isset property="junit.test.timezone"/>
		</condition>
		<property name="junit.test.timezone.info" value="[-]"/>
		<echo message="junit.test.timezone                 = ${junit.test.timezone.info}"/>
		<echo message="junit.test.datasource               = ${junit.test.datasource}"/>
		<echo message="junit.test.datasource.name          = ${junit.test.datasource.name}"/>
		<echo message="org.openmdx.tools.ant.is.available  = ${org.openmdx.tools.ant.is.available}"/>
	</target>

	<!--*******************************************************************
	* Initialization
	********************************************************************-->
	<target name="init">
		<antcontrib:propertyregex 
			property="project.implementation.prefix" 
			input="${ant.project.name}" 
			regexp="(.+)\-([^\-]+)" 
			select="\1"
		/>
		<tstamp>
			<format property="build.year" pattern="yyyy"/>
			<format property="build.starttime" pattern="${datetime.data.pattern}" timezone="UTC"/>
		</tstamp>
        <condition property="source.distribution">
            <or>
                <available file="${basedir}/src/java" type="dir"/>
                <available file="${basedir}/src/main/java" type="dir"/>
            </or>
        </condition>
		<condition property="unix.distribution">
			<or>
				<available file="${deliver.dir}/unix.distribution"/>
				<os family="unix"/>
			</or>
		</condition>
		<condition property="distribution.format" value="tar">
			<isset property="unix.distribution"/>
		</condition>
		<property name="distribution.format" value="zip"/>
		<available property="build.target.jre.found" file="${build.target.jre}" type="dir"/>
	</target>
	<target name="-ant-init" unless="org.openmdx.tools.ant.is.available">
		<taskdef 
			resource="org/openmdx/tools/ant/antlib.xml" 
			uri="xri://(antlib:org.openmdx.tools.ant)"
		>
			<classpath>
				<pathelement location="${openmdx.home}/apache/jre-1.5/ant/lib/ant.jar"/>
				<pathelement location="${openmdx.home}/apache/jre-1.2/contribution/lib/ant-contrib.jar"/>
				<pathelement location="${build.dir}/bin"/>
				<pathelement location="${basedir}/src/resource"/>
			</classpath>
		</taskdef>
		<property name="org.openmdx.tools.ant.is.available" value="true"/>
	</target>
	<target name="deliverables-init" depends="init,-ant-init">
		<openmdx:archivemanifest id="project.manifest">
			<attribute name="Specification-Vendor" value="${project.vendor.name}"/>
			<attribute name="Specification-Version" value="${project.specification.version}"/>
			<attribute name="Implementation-Vendor" value="${project.vendor.name}"/>
			<attribute name="Implementation-Vendor-Id" value="${project.vendor.id}"/>
			<attribute name="Implementation-Version" value="${project.implementation.version}-${build.starttime}"/>
		</openmdx:archivemanifest>
		<mkdir dir="${deliver.dir}/source-archive"/>
		<mkdir dir="${deliver.dir}/deployment-unit"/>
		<mkdir dir="${deliver.dir}/lib"/>
		<mkdir dir="${deliver.dir}/src"/>
		<mkdir dir="${deliver.dir}/doc"/>
		<mkdir dir="${src.archive.dir}"/>
		<antcontrib:if>
			<isset property="unix.distribution"/>
			<antcontrib:then>
				<touch file="${deliver.dir}/unix.distribution"/>
			</antcontrib:then>
		</antcontrib:if>
	</target>
	<target name="distribution-init" depends="init">
		<mkdir dir="${distribution.dir}"/>
	</target>
	<target name="build-init" depends="init">
		<fail 
			message="The project can't be built unless the sources are installed by 'ant install-src'" 
			unless="source.distribution"
		/>
		<fail 
			message="No build target version has been set" 
			unless="build.target.version"
		/>
		<fail 
			message="No build target edition has been set" 
			unless="build.target.platform"
		/>
		<mkdir dir="${build.dir}/bin"/>
		<mkdir dir="${build.dir}/doc/api"/>
		<mkdir dir="${build.dir}/lib"/>
		<mkdir dir="${build.dir}/model"/>
		<mkdir dir="${build.dir}/module"/>
		<mkdir dir="${build.dir}/src/resource"/>
		<mkdir dir="${build.dir}/src/sql"/>
		<property name="build.requires.jre13" value="true"/>
		<condition property="build.supports.jre13">
			<or>
				<equals arg1="${ant.java.version}" arg2="1.3"/>
				<equals arg1="${ant.java.version}" arg2="1.4"/>
				<equals arg1="${ant.java.version}" arg2="1.5"/>
				<equals arg1="${ant.java.version}" arg2="1.6"/>
				<equals arg1="${ant.java.version}" arg2="1.7"/>
				<equals arg1="${ant.java.version}" arg2="1.8"/>
				<equals arg1="${ant.java.version}" arg2="11"/>
				<equals arg1="${ant.java.version}" arg2="12"/>
			</or>
		</condition>
		<fail 
			message="Building for source version ${build.source.version} and target version ${build.target.version} requires Ant running under JRE 1.3 or later" 
			if="build.requires.jre13" 
			unless="build.supports.jre13"
		/>
		<condition property="build.requires.jre14">
			<or>
				<equals arg1="${build.source.version}" arg2="1.4"/>
				<equals arg1="${build.target.version}" arg2="1.4"/>
			</or>
		</condition>
		<condition property="build.supports.jre14">
			<or>
				<equals arg1="${ant.java.version}" arg2="1.4"/>
				<equals arg1="${ant.java.version}" arg2="1.5"/>
				<equals arg1="${ant.java.version}" arg2="1.6"/>
				<equals arg1="${ant.java.version}" arg2="1.7"/>
				<equals arg1="${ant.java.version}" arg2="1.8"/>
				<equals arg1="${ant.java.version}" arg2="11"/>
				<equals arg1="${ant.java.version}" arg2="12"/>
			</or>
		</condition>
		<fail 
			message="Building for source version ${build.source.version} and target version ${build.target.version} requires Ant running under JRE 1.4 or later" 
			if="build.requires.jre14" 
			unless="build.supports.jre14"
		/>
		<condition property="build.requires.jre15">
			<or>
				<equals arg1="${build.source.version}" arg2="1.5"/>
				<equals arg1="${build.target.version}" arg2="1.5"/>
			</or>
		</condition>
		<condition property="build.supports.jre15">
			<or>
				<equals arg1="${ant.java.version}" arg2="1.5"/>
				<equals arg1="${ant.java.version}" arg2="1.6"/>
				<equals arg1="${ant.java.version}" arg2="1.7"/>
				<equals arg1="${ant.java.version}" arg2="1.8"/>
				<equals arg1="${ant.java.version}" arg2="11"/>
				<equals arg1="${ant.java.version}" arg2="12"/>
			</or>
		</condition>
		<fail 
			message="Building for source version ${build.source.version} and target version ${build.target.version} requires Ant running under JRE 5 or later" 
			if="build.requires.jre15" 
			unless="build.supports.jre15"
		/>
		<condition property="build.requires.jre16">
			<or>
				<equals arg1="${build.source.version}" arg2="1.6"/>
				<equals arg1="${build.target.version}" arg2="1.6"/>
			</or>
		</condition>
		<condition property="build.supports.jre16">
			<or>
				<equals arg1="${ant.java.version}" arg2="1.6"/>
				<equals arg1="${ant.java.version}" arg2="1.7"/>
				<equals arg1="${ant.java.version}" arg2="1.8"/>
				<equals arg1="${ant.java.version}" arg2="11"/>
				<equals arg1="${ant.java.version}" arg2="12"/>
			</or>
		</condition>
		<fail 
			message="Building for source version ${build.source.version} and target version ${build.target.version} requires Ant running under JRE 6 or later" 
			if="build.requires.jre16" 
			unless="build.supports.jre16"
		/>
		<condition property="build.requires.jre17">
			<or>
				<equals arg1="${build.source.version}" arg2="1.7"/>
				<equals arg1="${build.target.version}" arg2="1.7"/>
			</or>
		</condition>
		<condition property="build.supports.jre17">
			<or>
				<equals arg1="${ant.java.version}" arg2="1.7"/>
				<equals arg1="${ant.java.version}" arg2="1.8"/>
				<equals arg1="${ant.java.version}" arg2="11"/>
				<equals arg1="${ant.java.version}" arg2="12"/>
			</or>
		</condition>
		<fail 
			message="Building for source version ${build.source.version} and target version ${build.target.version} requires Ant running under JRE 7 or later" 
			if="build.requires.jre17" 
			unless="build.supports.jre17"
		/>
		<condition property="build.requires.jre18">
			<or>
				<equals arg1="${build.source.version}" arg2="1.8"/>
				<equals arg1="${build.target.version}" arg2="1.8"/>
			</or>
		</condition>
		<condition property="build.supports.jre18">
			<or>
				<equals arg1="${ant.java.version}" arg2="1.8"/>
				<equals arg1="${ant.java.version}" arg2="11"/>
				<equals arg1="${ant.java.version}" arg2="12"/>
			</or>
		</condition>
		<fail 
			message="Building for source version ${build.source.version} and target version ${build.target.version} requires Ant running under JRE 8 or later" 
			if="build.requires.jre18" 
			unless="build.supports.jre18"
		/>
		<condition property="build.requires.java11">
			<or>
				<equals arg1="${build.source.version}" arg2="11"/>
				<equals arg1="${build.target.version}" arg2="11"/>
			</or>
		</condition>
		<condition property="build.supports.java11">
			<or>
				<equals arg1="${ant.java.version}" arg2="11"/>
				<equals arg1="${ant.java.version}" arg2="12"/>
			</or>
		</condition>
		<fail 
			message="Building for source version ${build.source.version} and target version ${build.target.version} requires Ant running under Java 11 or later" 
			if="build.requires.java11" 
			unless="build.supports.java11"
		/>
		
		<condition property="build.requires.rmi.compiler">
			<or>
				<isreference refid="project.rmi.jrmp.classes"/>
				<isreference refid="project.rmi.iiop.classes"/>
			</or>
		</condition>
	</target>
	
	<!--*******************************************************************
	* Preprocess JT files
	********************************************************************-->
	<target name="-preprocess-jt-files-" depends="-preprocess-jt-init" unless="preprocess-jt.target.is.up-to-date">
		<!--
		    Ant Java Pre-Processor task (https://sourceforge.net/projects/epptask/)
		-->
		<taskdef resource="epp.task" >
			<classpath>
				<pathelement location="${openmdx.home}/ant/thirdparty/epptask/lib/epptask.jar" />
			</classpath>
		</taskdef>
		<!-- Establish the directory structure because epp does not create -->
		<!-- directories itself :-( and fails otherwise                    -->
		<copy todir="${build.dir}/src/${preprocess-jt.target}">
			<fileset dir="${basedir}/src/jt">
				<exclude name="**/*.jt"/>
			</fileset>
		</copy>
		<antcontrib:for param="source-file">
			<path>
				<fileset dir="${basedir}/src/jt">
					<patternset refid="preprocess-jt.source.pattern"/>
				</fileset>
			</path>
			<sequential>
				<antcontrib:var name="target-file" unset="true" />
				<!-- build target file name -->
				<pathconvert property="target-file">
  					<path location="@{source-file}"/>
  					<globmapper 
						from="${basedir}/src/jt/*.jt" 
						to="${build.dir}/src/${preprocess-jt.target}/*.${preprocess-jt.target}"
						handledirsep="true"
					/>
				</pathconvert>
				<!-- run preprocessor -->
				<epp
					srcfile="@{source-file}"
					destfile="${target-file}"
					incdir="${basedir}/src/jt/org/openmdx/base/accessor/jmi/spi"
					defs="${preprocess-jt.tag1},${preprocess-jt.tag2},${preprocess-jt.tag3},${preprocess-jt.tag4},${preprocess-jt.tag5},${preprocess-jt.tag6},${preprocess-jt.tag7},${project.build.preprocess.tag1},${project.build.preprocess.tag2}" />
				<!--<echo>diff @{source-file} ${target-file} </echo>-->
			</sequential>
		</antcontrib:for>
	</target>
	<target name="-preprocess-jt-init">
		<antcontrib:if>
			<equals arg1="${preprocess-jt.target}" arg2="java"/>
			<antcontrib:then>
				<antcontrib:if>
					<equals arg1="${build.source.version}" arg2="1.3"/>
					<antcontrib:then>
						<property name="preprocess-jt.tag1" value="SINCE13"/>
						<property name="preprocess-jt.tag2" value="BEFORE14"/>
						<property name="preprocess-jt.tag3" value="BEFORE15"/>
						<property name="preprocess-jt.tag4" value="BEFORE16"/>
						<property name="preprocess-jt.tag5" value="BEFORE17"/>
						<property name="preprocess-jt.tag6" value="BEFORE18"/>
						<property name="preprocess-jt.tag7" value="OPENMDX1"/>
					</antcontrib:then>
				</antcontrib:if>
				<antcontrib:if>
					<equals arg1="${build.source.version}" arg2="1.4"/>
					<antcontrib:then>
						<property name="preprocess-jt.tag1" value="SINCE13"/>
						<property name="preprocess-jt.tag2" value="SINCE14"/>
						<property name="preprocess-jt.tag3" value="BEFORE15"/>
						<property name="preprocess-jt.tag4" value="BEFORE16"/>
						<property name="preprocess-jt.tag5" value="BEFORE17"/>
						<property name="preprocess-jt.tag6" value="BEFORE18"/>
						<property name="preprocess-jt.tag7" value="OPENMDX1"/>
					</antcontrib:then>
				</antcontrib:if>
				<antcontrib:if>
					<equals arg1="${build.source.version}" arg2="1.5"/>
					<antcontrib:then>
						<property name="preprocess-jt.tag1" value="SINCE13"/>
						<property name="preprocess-jt.tag2" value="SINCE14"/>
						<property name="preprocess-jt.tag3" value="SINCE15"/>
						<property name="preprocess-jt.tag4" value="BEFORE16"/>
						<property name="preprocess-jt.tag5" value="BEFORE17"/>
						<property name="preprocess-jt.tag6" value="BEFORE18"/>
						<property name="preprocess-jt.tag7" value="OPENMDX1"/>
					</antcontrib:then>
				</antcontrib:if>
				<antcontrib:if>
					<equals arg1="${build.source.version}" arg2="1.6"/>
					<antcontrib:then>
						<property name="preprocess-jt.tag1" value="SINCE13"/>
						<property name="preprocess-jt.tag2" value="SINCE14"/>
						<property name="preprocess-jt.tag3" value="SINCE15"/>
						<property name="preprocess-jt.tag4" value="SINCE16"/>
						<property name="preprocess-jt.tag5" value="BEFORE17"/>
						<property name="preprocess-jt.tag6" value="BEFORE18"/>
						<property name="preprocess-jt.tag7" value="OPENMDX2"/>
					</antcontrib:then>
				</antcontrib:if>
				<antcontrib:if>
					<equals arg1="${build.source.version}" arg2="1.7"/>
					<antcontrib:then>
						<property name="preprocess-jt.tag1" value="SINCE13"/>
						<property name="preprocess-jt.tag2" value="SINCE14"/>
						<property name="preprocess-jt.tag3" value="SINCE15"/>
						<property name="preprocess-jt.tag4" value="SINCE16"/>
						<property name="preprocess-jt.tag5" value="SINCE17"/>
						<property name="preprocess-jt.tag6" value="BEFORE18"/>
						<property name="preprocess-jt.tag7" value="OPENMDX2"/>
					</antcontrib:then>
				</antcontrib:if>
				<antcontrib:if>
					<equals arg1="${build.source.version}" arg2="1.8"/>
					<antcontrib:then>
						<property name="preprocess-jt.tag1" value="SINCE13"/>
						<property name="preprocess-jt.tag2" value="SINCE14"/>
						<property name="preprocess-jt.tag3" value="SINCE15"/>
						<property name="preprocess-jt.tag4" value="SINCE16"/>
						<property name="preprocess-jt.tag5" value="SINCE17"/>
						<property name="preprocess-jt.tag6" value="SINCE18"/>
						<property name="preprocess-jt.tag7" value="OPENMDX2"/>
					</antcontrib:then>
				</antcontrib:if>
			</antcontrib:then>
			<antcontrib:else>
				<antcontrib:if>
					<equals arg1="${preprocess-jt.target}" arg2="jsl"/>
					<antcontrib:then>
						<property name="preprocess-jt.tag1" value="DOTNET"/>
						<property name="preprocess-jt.tag2" value="BEFORE14"/>
						<property name="preprocess-jt.tag3" value="BEFORE15"/>
						<property name="preprocess-jt.tag4" value="BEFORE16"/>
						<property name="preprocess-jt.tag5" value="OPENMDX1"/>
					</antcontrib:then>
				</antcontrib:if>
			</antcontrib:else>
		</antcontrib:if>
		<patternset id="preprocess-jt.source.pattern">
			<include name="**/*.jt"/>
			<exclude name="org/openmdx/base/accessor/jmi/spi/portability-macros.jt"/>
			<patternset refid="build.exclude"/>
		</patternset>
		<uptodate property="preprocess-jt.target.is.up-to-date">
			<srcfiles dir="${basedir}/src/jt">
				<patternset refid="preprocess-jt.source.pattern"/>
			</srcfiles>
			<mapper type="glob" from="*.jt" to="${build.dir}/src/${preprocess-jt.target}/*.${preprocess-jt.target}"/>
		</uptodate>
	</target>
	<!--*******************************************************************
	* Preprocess Model Files
	********************************************************************-->
	<target name="-preprocess-model-files-" depends="-preprocess-model-init,-preprocess-rose-models,-preprocess-rsm-models,-preprocess-emf-models" unless="model-files.are.up-to-date">
		<!-- Distributing the ZIP content -->
		<unzip dest="${build.dir}/src/java" src="${build.dir}/model/models.zip">
			<patternset>
				<include name="**/*.java"/>
			</patternset>
		</unzip>
		<unzip dest="${build.dir}/src/resource" src="${build.dir}/model/models.zip">
			<patternset>
				<include name="**/*.jdo"/>
				<include name="**/*.orm"/>
				<include name="**/orm.xml"/>
				<include name="**/openmdxorm.properties"/>
			</patternset>
		</unzip>
		<openmdx:archive destfile="${build.dir}/model/${ant.project.name}.openmdx-xmi.zip">
			<openmdx:archivefileset src="${build.dir}/model/models.zip">
				<include name="**/*.xsd"/>
				<include name="**/*.xml"/>
				<include name="**/*.wbxml"/>
			</openmdx:archivefileset>
		</openmdx:archive>
	</target>
	<target name="-preprocess-rose-models" depends="-preprocess-model-init" unless="model-files.are.up-to-date" if="model.transformation.source.is-rose">
		<echo>Transforming Rose models ${model.transformation.rose.file} to ${build.dir}/model/models.zip...</echo>
		<echo/>
		<echo>Externalizing Rose models to ${build.dir}/model/models.zip ...</echo>
		<antcontrib:if>
			<available file="${basedir}/src/main/resource" type="dir"/>
			<antcontrib:then>
				<java
					classname="org.openmdx.application.mof.externalizer.rose.RoseExternalizer"
					fork="true"
					failonerror="true"
					maxmemory="${build.memory.limit}"
					classpathref="${model.transformation.class.path}"
				>
					<sysproperty key="user.language" value="en"/>
					<sysproperty key="user.region" value="US"/>
					<sysproperty key="file.encoding" value="Cp1252"/>
					<arg value="--pathMapSymbol=$$curdir"/>
					<arg value="--pathMapPath=&amp;"/>
					<arg value="--pathMapSymbol=$$${project.implementation.prefix}_opt_openmdx"/>
					<arg value="--pathMapPath=${openmdx.home}"/>
					<arg value="--pathMapSymbol=$$thirdparty_models"/>
					<arg value="--pathMapPath=${model.transformation.rose.thirdparty}"/>
					<arg value="--mdlDir=${model.transformation.rose.dir}"/>
					<arg value="--pathMapSymbol=$$sandbox"/>
					<arg value="--pathMapPath=${model.transformation.rose.sandbox}"/>
					<arg value="--mdlFile=${model.transformation.rose.file}"/>
					<arg value="--out=${build.dir}/model/models.zip"/>
					<arg value="--openmdxjdoDir=${basedir}/src/main/resource"/>
					<arg line="${model.build.formats}"/>
					<arg value="%"/>
				</java>
			</antcontrib:then>
			<antcontrib:else>
				<java
					classname="org.openmdx.application.mof.externalizer.rose.RoseExternalizer"
					fork="true"
					failonerror="true"
					maxmemory="${build.memory.limit}"
					classpathref="${model.transformation.class.path}"
				>
					<sysproperty key="user.language" value="en"/>
					<sysproperty key="user.region" value="US"/>
					<sysproperty key="file.encoding" value="Cp1252"/>
					<arg value="--pathMapSymbol=$$curdir"/>
					<arg value="--pathMapPath=&amp;"/>
					<arg value="--pathMapSymbol=$$${project.implementation.prefix}_opt_openmdx"/>
					<arg value="--pathMapPath=${openmdx.home}"/>
					<arg value="--pathMapSymbol=$$thirdparty_models"/>
					<arg value="--pathMapPath=${model.transformation.rose.thirdparty}"/>
					<arg value="--mdlDir=${model.transformation.rose.dir}"/>
					<arg value="--pathMapSymbol=$$sandbox"/>
					<arg value="--pathMapPath=${model.transformation.rose.sandbox}"/>
					<arg value="--mdlFile=${model.transformation.rose.file}"/>
					<arg value="--out=${build.dir}/model/models.zip"/>
					<arg value="--openmdxjdoDir=${basedir}/src/resource"/>
					<arg line="${model.build.formats}"/>
					<arg value="%"/>
				</java>
			</antcontrib:else>
		</antcontrib:if>
	</target>
	<target name="-preprocess-rsm-models" depends="-preprocess-model-init" unless="model-files.are.up-to-date" if="model.transformation.source.is-rsm">
		<property name="model.transformation.rsm.url" value="file:src/model/rsm/models.emx"/>
		<echo>Transforming RSM models ${model.transformation.rsm.url} to ${build.dir}/model/models.zip...</echo>
		<!-- Externalizes the model metadata from an RSM model file -->
		<echo/>
		<echo>Externalizing RSM models to ${build.dir}/model/models.zip ...</echo>
		<antcontrib:if>
			<available file="${basedir}/src/main/resource" type="dir"/>
			<antcontrib:then>
				<java
					classname="org.openmdx.application.mof.externalizer.xmi.XMIExternalizer"
					fork="true"
					failonerror="true"
					maxmemory="${build.memory.limit}"
					classpathref="${model.transformation.class.path}"
				>
					<sysproperty key="user.language" value="en"/>
					<sysproperty key="user.region" value="US"/>
					<sysproperty key="file.encoding" value="Cp1252"/>
					<sysproperty key="org.openmdx.application.mof.externalizer.xmi.ignoreImportedPackage" value="true"/>
					<arg value="--pathMapSymbol=openMDX 2 ~ Core (RSM)"/>
					<arg value="--pathMapPath=file:${openmdx.home}/core/src/model/rsm/"/>
					<arg value="--pathMapSymbol=openMDX 2 ~ Security (RSM)"/>
					<arg value="--pathMapPath=file:${openmdx.home}/security/src/model/rsm/"/>
					<arg value="--pathMapSymbol=${thirdparty.model.name}"/>
					<arg value="--pathMapPath=file:${thirdparty.model.home}"/>
					<arg value="--url=${model.transformation.rsm.url}"/>
					<arg value="--xmi=rsm"/>
					<arg value="--out=${build.dir}/model/models.zip"/>
					<arg value="--openmdxjdo=${basedir}/src/main/resource"/>
					<arg line="${model.build.formats}"/>
					<arg value="%"/>
				</java>
			</antcontrib:then>
			<antcontrib:else>
				<java
					classname="org.openmdx.application.mof.externalizer.xmi.XMIExternalizer"
					fork="true"
					failonerror="true"
					maxmemory="${build.memory.limit}"
					classpathref="${model.transformation.class.path}"
				>
					<sysproperty key="user.language" value="en"/>
					<sysproperty key="user.region" value="US"/>
					<sysproperty key="file.encoding" value="Cp1252"/>
					<sysproperty key="org.openmdx.application.mof.externalizer.xmi.ignoreImportedPackage" value="true"/>
					<arg value="--pathMapSymbol=openMDX 2 ~ Core (RSM)"/>
					<arg value="--pathMapPath=file:${openmdx.home}/core/src/model/rsm/"/>
					<arg value="--pathMapSymbol=openMDX 2 ~ Security (RSM)"/>
					<arg value="--pathMapPath=file:${openmdx.home}/security/src/model/rsm/"/>
					<arg value="--pathMapSymbol=${thirdparty.model.name}"/>
					<arg value="--pathMapPath=file:${thirdparty.model.home}"/>
					<arg value="--url=${model.transformation.rsm.url}"/>
					<arg value="--xmi=rsm"/>
					<arg value="--out=${build.dir}/model/models.zip"/>
					<arg value="--openmdxjdo=${basedir}/src/resource"/>
					<arg line="${model.build.formats}"/>
					<arg value="%"/>
				</java>
			</antcontrib:else>
		</antcontrib:if>
	</target>
	<target name="-preprocess-emf-models" depends="-preprocess-model-init" unless="model-files.are.up-to-date" if="model.transformation.source.is-emf">
		<echo>Transforming EMF models ${basedir}/src/model/emf/src/uml/models.uml to ${build.dir}/model/models.zip...</echo>
		<!-- Externalizes the model metadata from a EMF model file -->
		<echo/>
		<echo>Externalizing EMF models to ${build.dir}/model/models.zip ...</echo>
		<antcontrib:if>
			<available file="${basedir}/src/main/resource" type="dir"/>
			<antcontrib:then>
				<java
					classname="org.openmdx.application.mof.externalizer.xmi.XMIExternalizer"
					fork="true"
					failonerror="true"
					maxmemory="${build.memory.limit}"
					classpathref="${model.transformation.class.path}"
				>
					<sysproperty key="user.language" value="en"/>
					<sysproperty key="user.region" value="US"/>
					<sysproperty key="file.encoding" value="Cp1252"/>
					<arg value="--pathMapSymbol=openMDX 2 ~ Core (EMF)"/>
					<arg value="--pathMapPath=file:${openmdx.home}/core/src/model/emf/"/>
					<arg value="--pathMapSymbol=openMDX 2 ~ Security (EMF)"/>
					<arg value="--pathMapPath=file:${openmdx.home}/security/src/model/emf/"/>
					<arg value="--pathMapSymbol=${thirdparty.model.name}"/>
					<arg value="--pathMapPath=file:${thirdparty.model.home}"/>
					<arg value="--url=file:src/model/emf/models.uml"/>
					<arg value="--xmi=emf"/>
					<arg value="--out=${build.dir}/model/models.zip"/>
					<arg value="--openmdxjdo=${basedir}/src/main/resource"/>
					<arg value="--dataproviderVersion=2"/> <!-- The dataproviderVersion default value is 1 -->
					<arg line="${model.build.formats}"/>
					<arg value="%"/>
				</java>
			</antcontrib:then>
			<antcontrib:else>
				<java
					classname="org.openmdx.application.mof.externalizer.xmi.XMIExternalizer"
					fork="true"
					failonerror="true"
					maxmemory="${build.memory.limit}"
					classpathref="${model.transformation.class.path}"
				>
					<sysproperty key="user.language" value="en"/>
					<sysproperty key="user.region" value="US"/>
					<sysproperty key="file.encoding" value="Cp1252"/>
					<arg value="--pathMapSymbol=openMDX 2 ~ Core (EMF)"/>
					<arg value="--pathMapPath=file:${openmdx.home}/core/src/model/emf/"/>
					<arg value="--pathMapSymbol=openMDX 2 ~ Security (EMF)"/>
					<arg value="--pathMapPath=file:${openmdx.home}/security/src/model/emf/"/>
					<arg value="--pathMapSymbol=${thirdparty.model.name}"/>
					<arg value="--pathMapPath=file:${thirdparty.model.home}"/>
					<arg value="--url=file:src/model/emf/models.uml"/>
					<arg value="--xmi=emf"/>
					<arg value="--out=${build.dir}/model/models.zip"/>
					<arg value="--openmdxjdo=${basedir}/src/resource"/>
					<arg value="--dataproviderVersion=2"/> <!-- The dataproviderVersion default value is 1 -->
					<arg line="${model.build.formats}"/>
					<arg value="%"/>
				</java>
			</antcontrib:else>
		</antcontrib:if>
	</target>
	<target name="-preprocess-model-init">
		<uptodate property="model-files.are.up-to-date" targetfile="${build.dir}/model/${ant.project.name}.openmdx-xmi.zip">
			<srcfiles dir="${basedir}/src/model" excludes="**/*.dott,**/*.umlclass"/>
		</uptodate>
		<condition property="model.transformation.source.is-rose">
			<equals arg1="${model.transformation.source}" arg2="rose"/>
		</condition>
		<condition property="model.transformation.source.is-rsm">
			<equals arg1="${model.transformation.source}" arg2="rsm"/>
		</condition>
		<condition property="model.transformation.source.is-emf">
			<equals arg1="${model.transformation.source}" arg2="emf"/>
		</condition>
		<mkdir dir="build/${build.target.platform}/log/model"/>
		<mkdir dir="${build.dir}/model"/>
		<mkdir dir="${build.dir}/src/java"/>
		<mkdir dir="${build.dir}/src/jsl"/>
	</target>
	<!-- ******************************************************************* -->
	<!-- * model-diagrams -->
	<!-- ******************************************************************* -->
	<target name="-render-diagram-">
		<basename property="dot.file.basename" file="${dot.file.name}" suffix=".dot" />
		<dirname property="dot.file.dirname" file="${dot.file.name}" />
		<exec executable="${env.GRAPHVIZ_HOME}/dot" dir="${dot.file.dirname}" output="${build.dir}/model/graphviz.log">
			<arg line="-Tpng -o ${dot.file.basename}.png ${dot.file.basename}.dot" />
		</exec>
		<delete file="${dot.file.name}" />
	</target>
	<target name="-render-album-">
		<exec executable="${env.ALBUM_HOME}/album" dir="${album.path}" output="${build.dir}/model/album.log">
			<arg line="-theme ${album.theme.name} -theme_path ${album.theme.path} -theme_url ${album.theme.url} -save_conf=off -clean=on" />
		</exec>
	</target>
	<target name="model-diagrams" description="Generate model diagrams">
		<property name="album.path" value="${build.dir}/model/diagrams/${project.vendor.name} ${project.implementation.version} Model" />
		<java classname="org.openmdx.base.mof.spi.Model_1DiagramDrawer" fork="true" classpathref="project.bin.classpath">
			<arg value="src/model/graphviz/diagrams" />
			<arg value="${build.dir}/model/diagrams/dot" />
		</java>
		<copy todir="${album.path}">
			<fileset dir="${build.dir}/model/diagrams/dot" />
			<fileset dir="src/model/graphviz/diagrams/" includes="**/*.jpg, **/*.gif" />
		</copy>
		<antcontrib:foreach target="-render-diagram-" param="dot.file.name">
			<path>
				<fileset dir="${album.path}" casesensitive="yes">
					<include name="**/*.dot" />
				</fileset>
			</path>
		</antcontrib:foreach>
		<antcall target="-render-album-" inheritAll="true" />
	</target>
	<!--*******************************************************************
	* Version Class
	********************************************************************-->
	<target name="-preprocess-version-files-">
		<mkdir dir="${build.dir}/src/java"/>
		<antcontrib:foreach list="${version-file.packages}" target="-version-file-" param="version-file.package-name" inheritall="true"/>
	</target>
	<target name="-version-file-" depends="-version-file-init-" unless="version-file.is.up-to-date">
		<echo>Preprocessing Version file: ${version-file.file-name}</echo>
		<copy file="${version-file.template-file}" tofile="${version-file.file-name}" overwrite="true">
			<filterset>
				<filter token="PACKAGE" value="${version-file.package-name}"/>
				<filtersfile file="${version-file.property-file}"/>
			</filterset>
		</copy>
	</target>
	<target name="-version-file-init-">
		<antcontrib:propertyregex property="version-file.package-dir" input="${version-file.package-name}" regexp="[.]" replace="/" global="true"/>
		<property name="version-file.file-name" location="${build.dir}/src/java/${version-file.package-dir}/Version.java"/>
		<uptodate property="version-file.is.up-to-date" targetfile="${version-file.file-name}">
			<srcfiles file="${version-file.template-file}"/>
			<srcfiles file="${version-file.property-file}"/>
		</uptodate>
	</target>
	<!--*******************************************************************
	* Test
	********************************************************************-->
	<target 
		name="test" 
		description="Run JUnit tests, e.g. 'ant test' or 'ant -Djunit.test.case=Test*ProtocolHandler test'" 
	>
		<mkdir dir="${tmp.dir}"/>
		<antcontrib:if>
			<isset property="test.id.list"/>
			<antcontrib:then>
				<!-- Iterate all tests listed in test.id.list -->
				<antcontrib:foreach list="${test.id.list}" target="-run-test-" param="test.id" delimiter="/" />
			</antcontrib:then>
			<antcontrib:else>
				<antcontrib:if>
					<isset property="junit.test.case"/>
					<antcontrib:then>
						<!-- Run tests specified by junit.test.case pattern -->
						<antcall target="-test-">
							<param name="test.id" value="default" />
							<param name="project.bin.classpath" value="project.bin.classpath" />
							<param name="junit.test.case.pattern" value="null.pattern" />
						</antcall>
					</antcontrib:then>
					<antcontrib:else>
						<!-- Run tests specified by project.junit.test.case pattern -->
						<antcall target="-test-">
							<param name="test.id" value="default" />
							<param name="project.bin.classpath" value="project.bin.classpath" />
							<param name="junit.test.case.pattern" value="project.junit.test.case" />
						</antcall>
					</antcontrib:else>
				</antcontrib:if>
			</antcontrib:else>
		</antcontrib:if>
	</target>
	<target name="-run-test-">
		<!-- Run test with test-specific project.bin.classpath and test.case.pattern -->
		<antcall target="-test-">
			<param name="project.bin.classpath" value="project.bin.classpath.${test.id}" />
			<param name="junit.test.case.pattern" value="junit.test.case.pattern.${test.id}" />
		</antcall>
	</target>
	<target 
		name="-test-"
		depends="-junit-test-log-properties,build"
	>
		<junit 
			printsummary="yes" 
			fork="yes" 
			haltonfailure="${junit.test.halt.on-failure}" 
			haltonerror="${junit.test.halt.on-error}" 
			failureproperty="junit-test.failed" 
			jvm="${build.target.jre}/bin/java" 
			maxmemory="${build.memory.limit}" 
			tempdir="${tmp.dir}"
		>
			<jvmarg value="-Djava.endorsed.dirs=${openmdx.home}/osgi/${build.java.platform}/endorsed/lib"/>
			<jvmarg value="-Xmx200M" />
			<classpath refid="${project.bin.classpath}"/>
			<formatter type="xml"/>
			<sysproperty key="${junit.set.timezone}" value="${junit.test.timezone}" />
			<sysproperty key="org.openmdx.comp.env.jdbc.DataSource" value="${junit.test.datasource}" />
			<sysproperty key="org.openmdx.comp.env.${junit.test.datasource.name}" value="${junit.test.datasource}" />
			<sysproperty key="org.openmdx.log.debug" value="${junit.test.log.debug}"/>
			<sysproperty key="org.openmdx.log.path" value="build/${build.target.platform}/log/junit"/>
			<sysproperty key="java.util.logging.config.file" value="build/${build.target.platform}/log/junit.${test.id}/logging.properties"/>
			<sysproperty key="java.protocol.handler.pkgs" value="org.openmdx.kernel.url.protocol"/>
			<sysproperty key="build.java.platform" value="${build.java.platform}"/>
			<sysproperty key="build.target.platform" value="${build.target.platform}"/>
			<sysproperty key="junit.test.tmp" value="${tmp.dir}"/>
			<batchtest todir="build/${build.target.platform}/log/junit.${test.id}/xml" if="junit.test.case">
				<fileset dir="${basedir}/src/java">
					<patternset>
						<include name="**/${junit.test.case}.java"/>
						<patternset refid="build.exclude"/>
					</patternset>
				</fileset>
			</batchtest>
			<batchtest todir="build/${build.target.platform}/log/junit.${test.id}/xml">
				<fileset dir="${basedir}/src/java">
					<patternset refid="${junit.test.case.pattern}" />
				</fileset>
			</batchtest>
		</junit>
		<antcontrib:if>
			<istrue value="${junit.test.report}"/>
			<antcontrib:then>
				<junitreport todir="build/${build.target.platform}/log/junit.${test.id}/xml">
					<fileset dir="build/${build.target.platform}/log/junit.${test.id}/xml">
						<include name="TEST-*.xml"/>
					</fileset>
					<report format="frames" todir="build/${build.target.platform}/log/junit.${test.id}/html"/>
				</junitreport>
				<echo>
	------------------------------------------------------------------------------------------------
	* The JUnit test report for ${ant.project.name} has been generated at 
	  build/${build.target.platform}/log/junit.${test.id}/html/index.html
	* The JUnit log file for ${ant.project.name} can be found at 
	  build/${build.target.platform}/log/junit.${test.id}/JUnit.shared.log
	------------------------------------------------------------------------------------------------
			    </echo>
			</antcontrib:then>
		</antcontrib:if>
	</target>
	<target name="-junit-test-init">
		<mkdir dir="build/${build.target.platform}/log/junit.${test.id}/xml"/>
		<condition property="junit.test.has.log.properties">
			<available file="logging.properties" filepath="build/${build.target.platform}/log/junit.${test.id}"/>
		</condition>
		<condition property="junit.has.test.case">
			<or>
				<isset property="junit.test.case"/>
				<isreference refid="project.junit.test.case"/>
			</or>
		</condition>
		<condition property="ant.lib.has.junit">
			<available classname="junit.framework.Test"/>
		</condition>
	</target>
	<target 
		name="-junit-test-log-properties" 
		depends="-junit-test-init" 
		unless="junit.test.has.log.properties" 
		if="junit.has.test.case"
	>
		<echo>Setting JUnit Test Log Properties: build/${build.target.platform}/log/junit.${test.id}/logging.properties</echo>
		<mkdir dir="${tmp.dir}"/>
		<mkdir dir="build/${build.target.platform}/log/junit.${test.id}"/>
		<echo file="build/${build.target.platform}/log/junit.${test.id}/logging.properties" append="false"># Log properties
handlers= java.util.logging.FileHandler
java.util.logging.FileHandler.level = ${junit.test.log.level}
java.util.logging.FileHandler.pattern = build/${build.target.platform}/log/junit.${test.id}/junit.%u.log
java.util.logging.FileHandler.formatter = ${openmdx.log.formatter}
	    </echo>
	</target>
	<!--*******************************************************************
	* Clean
	********************************************************************-->
	<target name="clean" description="Cleans the project's tree" depends="init">
		<fail message="The project can't be cleaned unless the sources are installed by 'ant install-src'" unless="source.distribution"/>
		<delete includeEmptyDirs="true">
			<fileset dir="${basedir}">
				<patternset refid="clear.project.pattern"/>
			</fileset>
		</delete>
		<antcontrib:foreach list="${project.platform.list}" target="-clean-" param="build.target.platform" delimiter="/"/>
	</target>
	<target name="-clean-">
		<delete includeEmptyDirs="true">
			<fileset dir="${project.home}">
				<patternset refid="clear.platform.pattern"/>
			</fileset>
		</delete>
	</target>
	<!--*******************************************************************
	* Build
	********************************************************************-->
	<target name="build" description="Compiles the classes" depends="compile-java,compile-rmi"/>
	<target name="compile-rmi" description="Invokes the RMI compiler" depends="compile-java,build-init" if="build.requires.rmi.compiler">
		<property name="java.bootstrap.classpath" refid="java.bootstrap.lib"/>
		<rmic 
			base="${build.dir}/bin" 
			stubversion="compat" 
			includeAntRuntime="false" 
			extdirs="${build.target.jre}/ext" 
			classpathref="project.bin.classpath" 
			verify="true">
			<patternset refid="project.rmi.jrmp.classes"
		/>
			<compilerarg value="-bootclasspath"/>
			<compilerarg value="${java.bootstrap.classpath}"/>
		</rmic>
		<rmic 
			iiop="true" 
			base="${build.dir}/bin" 
			stubversion="compat" 
			includeAntRuntime="false" 
			extdirs="${build.target.jre}/ext" 
			classpathref="project.bin.classpath" 
			verify="true"
		>
			<patternset refid="project.rmi.iiop.classes"/>
			<compilerarg value="-bootclasspath"/>
			<compilerarg value="${java.bootstrap.classpath}"/>
		</rmic>
		<property name="eclipse.rmi" location="${basedir}/build/${build.target.platform}/eclipse/bin"/>
		<mkdir dir="${build.dir}/lib"/>
		<jar destfile="${build.dir}/lib/${ant.project.name}.rmi.jar">
			<zipfileset dir="${build.dir}/bin">
				<include name="**/*_Stub.class"/>
				<include name="**/*_Tie.class"/>
				<include name="**/*_Skel.class"/>
			</zipfileset>
		</jar>
	</target>
	<target name="compile-java" description="Compiles the classes" depends="generate">
		<antcontrib:if>
			<isset property="build.emulate.platform"/>
			<antcontrib:then>
				<echo message="Cross compile for JRE ${build.source.version} under JRE ${ant.java.version}"/>
				<antcontrib:if>
					<available file="java" filepath="${build.dir}/src" type="dir"/>
					<antcontrib:then>
						<javac 
							destdir="${build.dir}/bin" 
							debug="${build.debug}"
							encoding="UTF-8"
							optimize="${build.optimize}" 
							fork="true" 
							memoryMaximumSize="${build.memory.limit}" 
							classpathref="project.lib.classpath" 
							source="${build.source.version}" 
							target="${build.target.version}"
							includeantruntime="${build.include.ant.runtime}"
						>
							<src>
								<pathelement location="${build.dir}/src/java"/>
                                <dirset dir="${basedir}/src" includes="java/** main/java**"/>
							</src>
							<patternset refid="build.exclude"/>
						</javac>
					</antcontrib:then>
					<antcontrib:else>
						<javac 
							destdir="${build.dir}/bin" 
							debug="${build.debug}"
							encoding="UTF-8"
							optimize="${build.optimize}" 
							fork="true" 
							memoryMaximumSize="${build.memory.limit}" 
							classpathref="project.lib.classpath" 
							source="${build.source.version}" 
							target="${build.target.version}"
							includeantruntime="${build.include.ant.runtime}"
						>
							<src>
                                <dirset dir="${basedir}/src" includes="java/** main/java**"/>
							</src>
							<patternset refid="build.exclude"/>
						</javac>
					</antcontrib:else>
				</antcontrib:if>
			</antcontrib:then>
			<antcontrib:else>
				<fail message="JRE ${build.target.jre} not found" unless="build.target.jre.found"/>
				<antcontrib:if>
					<available file="java" filepath="${build.dir}/src" type="dir"/>
					<antcontrib:then>
						<antcontrib:if>
							<istrue value="${build.compile.without.bootclasspath}"/>
							<antcontrib:then>
								<javac 
									destdir="${build.dir}/bin" 
									debug="${build.debug}"
									encoding="UTF-8"
									optimize="${build.optimize}" 
									fork="true" memoryMaximumSize="${build.memory.limit}" 
									classpathref="project.lib.classpath" 
									source="${build.source.version}" 
									target="${build.target.version}" 
									extdirs="${build.target.jre}/ext"
									includeantruntime="${build.include.ant.runtime}"
								>
									<src>
										<pathelement location="${build.dir}/src/java"/>
                                        <dirset dir="${basedir}/src" includes="java/** main/java**"/>
									</src>
									<patternset refid="build.exclude"/>
								</javac>
							</antcontrib:then>
							<antcontrib:elseif>
								<istrue value="${build.compile.without.bootclasspath+compliance-level}"/>
								<antcontrib:then>
									<javac 
										destdir="${build.dir}/bin" 
										debug="${build.debug}"
										encoding="UTF-8"
										optimize="${build.optimize}" 
										fork="true" 
										memoryMaximumSize="${build.memory.limit}" 
										classpathref="project.lib.classpath" 
										extdirs="${build.target.jre}/ext"
										includeantruntime="${build.include.ant.runtime}"
									>
										<src>
											<pathelement location="${build.dir}/src/java"/>
	                                        <dirset dir="${basedir}/src" includes="java/** main/java**"/>
										</src>
										<patternset refid="build.exclude"/>
									</javac>
								</antcontrib:then>
							</antcontrib:elseif>
							<antcontrib:else>
								<javac 
									destdir="${build.dir}/bin" 
									debug="${build.debug}"
									encoding="UTF-8"
									optimize="${build.optimize}" 
									fork="true" memoryMaximumSize="${build.memory.limit}" 
									classpathref="project.lib.classpath" 
									source="${build.source.version}" 
									target="${build.target.version}" 
									bootclasspathref="java.bootstrap.lib" 
									extdirs="${build.target.jre}/ext"
									includeantruntime="${build.include.ant.runtime}"
								>
									<src>
										<pathelement location="${build.dir}/src/java"/>
                                        <dirset dir="${basedir}/src" includes="java/** main/java**"/>
									</src>
									<patternset refid="build.exclude"/>
								</javac>
							</antcontrib:else>
						</antcontrib:if>
					</antcontrib:then>
					<antcontrib:else>
						<antcontrib:if>
							<istrue value="${build.compile.without.bootclasspath}"/>
							<antcontrib:then>
								<javac 
									destdir="${build.dir}/bin" 
									debug="${build.debug}"
									encoding="UTF-8"
									optimize="${build.optimize}" 
									fork="true" 
									memoryMaximumSize="${build.memory.limit}" 
									classpathref="project.lib.classpath" 
									source="${build.source.version}" 
									target="${build.target.version}" 
									extdirs="${build.target.jre}/ext"
									includeantruntime="${build.include.ant.runtime}"
								>
									<src>
                                        <dirset dir="${basedir}/src" includes="java/** main/java**"/>
									</src>
									<patternset refid="build.exclude"/>
								</javac>
							</antcontrib:then>
							<antcontrib:elseif>
								<istrue value="${build.compile.without.bootclasspath+compliance-level}"/>
								<antcontrib:then>
									<javac 
										destdir="${build.dir}/bin" 
										debug="${build.debug}"
										encoding="UTF-8"
										optimize="${build.optimize}" 
										fork="true" memoryMaximumSize="${build.memory.limit}" 
										classpathref="project.lib.classpath" 
										extdirs="${build.target.jre}/ext"
										includeantruntime="${build.include.ant.runtime}"
									>
										<src>
	                                        <dirset dir="${basedir}/src" includes="java/** main/java**"/>
										</src>
										<patternset refid="build.exclude"/>
									</javac>
								</antcontrib:then>
							</antcontrib:elseif>
							<antcontrib:elseif>
								<istrue value="${build.requires.java11}"/>
								<antcontrib:then>
									<echo>JAVAC:standard</echo>
									<javac 
										destdir="${build.dir}/bin" 
										debug="${build.debug}"
										encoding="UTF-8"
										optimize="${build.optimize}" 
										fork="true" 
										memoryMaximumSize="${build.memory.limit}" 
										classpathref="project.lib.classpath" 
										source="${build.source.version}" 
										target="${build.target.version}" 
										bootclasspathref="java.bootstrap.lib" 
										includeantruntime="${build.include.ant.runtime}"
									>
										<src>
	                                        <dirset dir="${basedir}/src" includes="java/** main/java**"/>
										</src>
										<patternset refid="build.exclude"/>
									</javac>
								</antcontrib:then>
							</antcontrib:elseif>
							<antcontrib:else>
								<echo>JAVAC:classic</echo>
								<javac 
									destdir="${build.dir}/bin" 
									debug="${build.debug}"
									encoding="UTF-8"
									optimize="${build.optimize}" 
									fork="true" 
									memoryMaximumSize="${build.memory.limit}" 
									classpathref="project.lib.classpath" 
									source="${build.source.version}" 
									target="${build.target.version}" 
									bootclasspathref="java.bootstrap.lib" 
									extdirs="${build.target.jre}/ext"
									includeantruntime="${build.include.ant.runtime}"
								>
									<src>
                                        <dirset dir="${basedir}/src" includes="java/** main/java**"/>
									</src>
									<patternset refid="build.exclude"/>
								</javac>
							</antcontrib:else>
						</antcontrib:if>
					</antcontrib:else>
				</antcontrib:if>
			</antcontrib:else>
		</antcontrib:if>
	</target>
	<target 
		name="create-schema" 
		unless="build.ignore.jpa"
		depends="build-init"
  	>
		<taskdef 
  			name="mappingtool" 
  			classname="org.apache.openjpa.jdbc.ant.MappingToolTask" 
  			classpathref="jpa.ant.bin"
  		/>
		<mappingtool action="buildSchema" schemaFile="${build.dir}/src/sql/openjpa-schema.xml">
			<fileset dir="${build.dir}/bin">
				<include name="**/jpa3/*.class"/>
				<exclude name="**/jpa3/*$*.class"/>
				<patternset refid="build.exclude"/>
			</fileset>
			<config propertiesFile="${basedir}/etc/openjpa/${database.name}-persistence.xml"/>
			<classpath>
				<path refid="jpa.ant.bin"/>
			</classpath>
		</mappingtool>
	</target>
	<!--*******************************************************************
	* Distribution Archives
	********************************************************************-->
	<target name="source-archives" depends="deliverables-init">
		<property name="src-archive.prefix" value="${src.archive.dir}/${ant.project.name}."/>
		<property name="built-src-archive.prefix" value="${deliver.dir}/src/${ant.project.name}."/>
		<condition property="src-deliverable.pattern.id" value="all.pattern">
			<not>
				<isset property="src-deliverable.pattern.id"/>
			</not>
		</condition>
		<antcontrib:foreach target="-deliverable-" param="deliverable.source">
			<path>
				<dirset dir="${basedir}/src">
					<include name="*"/>
					<exclude name="model"/>
					<exclude name="data"/>
					<exclude name="connector"/>
					<exclude name="?ar"/>
				</dirset>
			</path>
			<param name="deliverable.prefix" value="${src-archive.prefix}"/>
			<param name="deliverable.suffix" value=""/>
			<param name="deliverable.pattern" value="${src-deliverable.pattern.id}"/>
		</antcontrib:foreach>
		<antcontrib:foreach target="-deliverable-" param="deliverable.source">
			<path>
				<dirset dir="${basedir}/src">
					<include name="?ar"/>
				</dirset>
			</path>
			<param name="deliverable.prefix" value="${src-archive.prefix}"/>
			<param name="deliverable.suffix" value=""/>
			<param name="deliverable.pattern" value="all.pattern"/>
		</antcontrib:foreach>
		<antcontrib:if>
			<available file="${build.dir}/src" type="dir"/>
			<antcontrib:then>
				<antcontrib:foreach target="-deliverable-" param="deliverable.source">
					<path>
						<dirset dir="${build.dir}/src" includes="*"/>
					</path>
					<param name="deliverable.prefix" value="${built-src-archive.prefix}"/>
					<param name="deliverable.suffix" value=""/>
					<param name="deliverable.pattern" value="all.pattern"/>
				</antcontrib:foreach>
			</antcontrib:then>
		</antcontrib:if>
		<antcontrib:if>
			<available file="${basedir}/src/model" type="dir"/>
			<antcontrib:then>
				<antcontrib:foreach target="-deliverable-" param="deliverable.source">
					<path>
						<dirset dir="${basedir}/src/model" includes="*"/>
					</path>
					<param name="deliverable.prefix" value="${src-archive.prefix}"/>
					<param name="deliverable.suffix" value="-model"/>
					<param name="deliverable.pattern" value="all.pattern"/>
				</antcontrib:foreach>
			</antcontrib:then>
		</antcontrib:if>
		<antcontrib:if>
			<available file="${basedir}/src/data" type="dir"/>
			<antcontrib:then>
				<antcontrib:foreach target="-deliverable-" param="deliverable.source">
					<path>
						<dirset dir="${basedir}/src/data" includes="*"/>
					</path>
					<param name="deliverable.prefix" value="${src-archive.prefix}"/>
					<param name="deliverable.suffix" value="-data"/>
					<param name="deliverable.pattern" value="all.pattern"/>
				</antcontrib:foreach>
			</antcontrib:then>
		</antcontrib:if>
		<antcontrib:if>
			<available file="${basedir}/src/connector" type="dir"/>
			<antcontrib:then>
				<antcontrib:foreach target="-deliverable-" param="deliverable.source">
					<path>
						<dirset dir="${basedir}/src/connector" includes="*"/>
					</path>
					<param name="deliverable.prefix" value="${src-archive.prefix}"/>
					<param name="deliverable.suffix" value="-connector"/>
					<param name="deliverable.pattern" value="all.pattern"/>
				</antcontrib:foreach>
			</antcontrib:then>
		</antcontrib:if>
	</target>
	<target name="doc-archives" depends="distribution-init">
		<antcall target="-deliverable-">
			<param name="deliverable.source" value="${build.dir}/doc/api"/>
			<param name="deliverable.prefix" value="${basedir}/deliverables/doc/${ant.project.name}.doc-"/>
			<param name="deliverable.suffix" value=""/>
			<param name="deliverable.pattern" value="all.pattern"/>
		</antcall>
	</target>
	<target name="-deliverable-" depends="init">
		<basename property="deliverable.tag" file="${deliverable.source}"/>
		<property name="deliverable.target" value="${deliverable.prefix}${deliverable.tag}${deliverable.suffix}"/>
		<openmdx:archive format="zip" destfile="${deliverable.target}.zip" basedir="${deliverable.source}">
			<patternset refid="${deliverable.pattern}"/>
		</openmdx:archive>
	</target>
	<!--*******************************************************************
	* Java API Documentation
	********************************************************************-->
	<target name="api-doc-init" depends="build">
		<mkdir dir="${build.dir}/doc/api" />
		<mkdir dir="${deliver.dir}/doc"/>
		<tstamp>
			<format property="build.year" pattern="yyyy"/>
			<format property="build.starttime" pattern="${datetime.data.pattern}" timezone="UTC"/>
		</tstamp>
		<antcontrib:if>
			<available file="java" filepath="${build.dir}/src" type="dir"/>
			<antcontrib:then>
				<uptodate property="api-doc.is.up-to-date">
					<srcfiles dir="${basedir}/src/java"/>
					<srcfiles dir="${build.dir}/src/java"/>
					<mapper type="glob" from="*.java" to="${build.dir}/doc/api/*.html"/>
				</uptodate>
			</antcontrib:then>
			<antcontrib:else>
				<uptodate property="api-doc.is.up-to-date">
					<srcfiles dir="${basedir}/src/java"/>
					<mapper type="glob" from="*.java" to="${build.dir}/doc/api/*.html"/>
				</uptodate>
			</antcontrib:else>
		</antcontrib:if>
	</target>
	<!--*******************************************************************
	* Prepare
	********************************************************************-->
	<target name="prepare" description="Installs a binary distribution or builds a source distribution" depends="init">
		<antcontrib:if>
			<isset property="source.distribution"/>
			<antcontrib:then>
				<antcall target="deliverables"/>
			</antcontrib:then>
			<antcontrib:else>
				<antcall target="install-bin"/>
			</antcontrib:else>
		</antcontrib:if>
	</target>
	<!--*******************************************************************
	* Install
	********************************************************************-->
	<target 
		name="install-src" 
		description="Converts a generic distribution to a source distribution" 
		unless="source.distribution" 
		depends="init,install-model,install-data,install-sql,install-connector,eclipse-src-project,install-war,install-ear">
		<antcontrib:foreach target="-install-" param="install.source">
			<path>
				<fileset dir="${src.archive.dir}">
					<include name="${ant.project.name}.*.zip"/>
					<exclude name="*-connector.*"/>
					<exclude name="*-data.*"/>
					<exclude name="*.ear.*"/>
					<exclude name="*-model.*"/>
					<exclude name="*-sql.*"/>
					<exclude name="*.war.*"/>
				</fileset>
			</path>
			<param name="install.target" value="${basedir}/src"/>
			<param name="install.suffix" value=""/>
		</antcontrib:foreach>
	</target>
	<target 
		name="install-bin" 
		description="Converts a generic distribution to a binary distribution" 
		depends="install-model,install-sql,install-ear,install-war,install-source-archive,eclipse-bin-project"
	>
		<antcontrib:if>
			<isset property="install-bin.callback"/>
			<antcontrib:then>
				<antcall 
					target="${install-bin.callback}"
					inheritrefs="true"
				/>
			</antcontrib:then>
		</antcontrib:if>
	</target>
	<target name="install-source-archive" depends="init">
		<antcontrib:foreach 
			list="${project.platform.list}" 
			target="-src-for-platform-" 
			param="build.target.platform" 
			delimiter="/"
		>
			<param name="project.implementation.prefix" value="${project.implementation.prefix}"/>
		</antcontrib:foreach>
	</target>
	<target name="-src-for-platform-" unless="build.exclude.${build.target.platform}">
		<antcall target="-src-for-platform" inheritAll="false">
			<param name="build.target.platform" value="${build.target.platform}"/>
		</antcall>
	</target>
	<target name="-src-for-platform" depends="-init-platform" unless="build.exclude.platform">
		<antcontrib:foreach target="-src-for-jar-" param="jar.file">
			<path>
				<fileset dir="${deliver.dir}/lib">
					<include name="*.jar"/>
				</fileset>
			</path>
			<param name="java-archive.platform-independent" value="${project.home}/source-archive/${base.dir.name}/${ant.project.name}.java.zip"/>
			<param name="java-archive.platform-dependent" value="${deliver.dir}/src/${ant.project.name}.java.zip"/>
		</antcontrib:foreach>
	</target>
	<target name="-src-for-jar-">
		<basename property="jar.name" file="${jar.file}"/>
		<antcontrib:if>
			<isreference refid="${jar.name}.content"/>
			<antcontrib:then>
				<antcontrib:propertyregex property="zip.name" input="${jar.name}" override="true" regexp="(.*)\.jar" select="\1.java.zip"/>
				<mkdir dir="${deliver.dir}/src"/>
				<antcall target="-src-for-jar" inheritAll="false">
					<param name="java-archive.platform-independent" value="${java-archive.platform-independent}"/>
					<param name="java-archive.platform-dependent" value="${java-archive.platform-dependent}"/>
					<param name="java-archive.target" value="${deliver.dir}/src/${zip.name}"/>
					<reference refid="${jar.name}.content" torefid="java-archive.classes"/>
				</antcall>
			</antcontrib:then>
		</antcontrib:if>
	</target>
	<target name="-src-for-jar">
		<openmdx:archive format="zip" destfile="${java-archive.target}">
			<openmdx:archivefileset 
				src="${java-archive.platform-independent}" 
				format="zip"
				whenmissing="skip"
			>
				<patternset refid="java-archive.classes"/>
			</openmdx:archivefileset>
			<openmdx:archivefileset 
				src="${java-archive.platform-dependent}" 
				format="zip"
				whenmissing="skip"
			>
				<patternset refid="java-archive.classes"/>
			</openmdx:archivefileset>
		</openmdx:archive>
	</target>
	<target name="install-model" unless="source.distribution" depends="init">
		<antcontrib:foreach target="-install-" param="install.source">
			<path>
				<fileset dir="${src.archive.dir}">
					<include name="${ant.project.name}.*-model.zip"/>
				</fileset>
			</path>
			<param name="install.target" value="${basedir}/src/model"/>
			<param name="install.suffix" value="-model"/>
		</antcontrib:foreach>
	</target>
	<target name="install-data" unless="source.distribution" depends="init">
		<antcontrib:foreach target="-install-" param="install.source">
			<path>
				<fileset dir="${src.archive.dir}">
					<include name="${ant.project.name}.*-data.zip"/>
				</fileset>
			</path>
			<param name="install.target" value="${basedir}/src/data"/>
			<param name="install.suffix" value="-data"/>
		</antcontrib:foreach>
	</target>
	<target name="install-sql" unless="source.distribution" depends="init">
		<antcontrib:foreach target="-install-" param="install.source">
			<path>
				<fileset dir="${src.archive.dir}">
					<include name="${ant.project.name}.*-sql.zip"/>
				</fileset>
			</path>
			<param name="install.target" value="${basedir}/src/sql"/>
			<param name="install.suffix" value="-sql"/>
		</antcontrib:foreach>
	</target>
	<target name="install-connector" unless="source.distribution" depends="init">
		<antcontrib:foreach target="-install-" param="install.source">
			<path>
				<fileset dir="${src.archive.dir}">
					<include name="${ant.project.name}.*-connector.zip"/>
				</fileset>
			</path>
			<param name="install.target" value="${basedir}/src/connector"/>
			<param name="install.suffix" value="-connector"/>
		</antcontrib:foreach>
	</target>
	<target 
		name="eclipse-bin-project" 
		unless="source.distribution" 
		depends="init"
	>
		<antcontrib:if>
			<available file="${basedir}/etc/eclipse/bin.project.zip"/>
			<antcontrib:then>
				<unzip
					src="${basedir}/etc/eclipse/bin.project.zip"
					dest="${project.home}"
				/>
			</antcontrib:then>
		</antcontrib:if>
	</target>
	<target 
		name="eclipse-src-project" 
		unless="source.distribution" 
		depends="init"
	>
		<antcontrib:if>
			<available file="${basedir}/etc/eclipse/src.project.zip"/>
			<antcontrib:then>
				<unzip
					src="${basedir}/etc/eclipse/src.project.zip"
					dest="${project.home}"
				/>
			</antcontrib:then>
		</antcontrib:if>
	</target>
	<target name="install-war" unless="source.distribution" depends="init">
		<antcontrib:foreach target="-install-" param="install.source">
			<path>
				<fileset dir="${src.archive.dir}">
					<include name="${ant.project.name}.war.zip"/>
				</fileset>
			</path>
			<param name="install.target" value="${basedir}/src"/>
			<param name="install.suffix" value="war"/>
			<param name="install.tag" value="war"/>
		</antcontrib:foreach>
	</target>
	<target name="install-ear" unless="source.distribution" depends="init">
		<antcontrib:foreach target="-install-" param="install.source">
			<path>
				<fileset dir="${src.archive.dir}">
					<include name="${ant.project.name}.ear.zip"/>
				</fileset>
			</path>
			<param name="install.target" value="${basedir}/src"/>
			<param name="install.suffix" value="ear"/>
			<param name="install.tag" value="ear"/>
		</antcontrib:foreach>
	</target>
	<target name="-install-" depends="init">
		<antcontrib:propertyregex property="install.tag" input="${install.source}" regexp="${ant.project.name}\.(.+)${install.suffix}\.zip" select="\1"/>
		<echo>Installing ${install.source} to ${install.target}/${install.tag}...</echo>
		<mkdir dir="${install.target}/${install.tag}"/>
		<unzip src="${install.source}" dest="${install.target}/${install.tag}"/>
	</target>
	<!--*******************************************************************
	* All
	********************************************************************-->
	<target 
		name="all" 
		description="Processes all the project's platforms" 
		depends="clean"
	>
		<antcontrib:foreach 
			list="${project.platform.list}" 
			target="-platform-" 
			param="build.target.platform" 
			delimiter="/"
		/>
	</target>
	<target 
		name="-platform-" 
		unless="build.exclude.${build.target.platform}"
	>
		<antcall 
			target="platform" 
			inheritAll="false"
		>
			<param name="build.target.platform" value="${build.target.platform}"/>
		</antcall>
	</target>
	<target 
		name="platform" 
		description="Builds, tests and distributes the platform specified by -Dbuild.target.platform" 
		depends="-init-platform" 
	>
		<antcontrib:if>
			<isset property="build.exclude.platform"/>
			<antcontrib:then>
				<echo>Platform ${build.target.platform} is excluded from the build process</echo>
			</antcontrib:then>
			<antcontrib:else>
				<antcall target="-include-platform-"/>
			</antcontrib:else>
		</antcontrib:if>
	</target>
	<target name="-include-platform-" depends="init,test,distribution"/>
	<target name="-init-platform"/>

</project>
